name: Issue Report Scheduler

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      frequency:
        description: 'Report Frequency'
        required: true
        default: 'daily'
        type: choice
        options:
        - daily
        - weekly
        - monthly
      email:
        description: 'Email Recipient(s) (comma-separated)'
        required: false
        default: ''

jobs:
  report:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    - name: Run Issue Aggregator
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        SMTP_EMAIL: ${{ secrets.SMTP_EMAIL }}
        SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
        GITHUB_REPO: ${{ github.repository }}
      run: |
        # Determine frequency (use input or default to daily for cron)
        FREQ="${{ inputs.frequency || 'daily' }}"
        EMAIL="${{ inputs.email }}"
        
        echo "Running $FREQ report..."
        python scripts/issue_aggregator.py --frequency "$FREQ" --email "$EMAIL"

    - name: Upload Report Artifact
      uses: actions/upload-artifact@v3
      with:
        name: issue-report
        path: reports/*.json
